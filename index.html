<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Dobbelstenen flits</title>
<style>
  :root {
    --bg1: #6a11cb;
    --bg2: #2575fc;
    --glass: rgba(255,255,255,0.12);
    --glass2: rgba(255,255,255,0.18);
    --text: rgba(255,255,255,0.96);
    --muted: rgba(255,255,255,0.78);
    --shadow: 0 18px 45px rgba(0,0,0,0.25);
    --radius: 22px;
    --topbar-h: 72px;
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color: var(--text);
    background: radial-gradient(900px 500px at 20% 10%, rgba(255,255,255,0.18), transparent 55%),
                linear-gradient(135deg, var(--bg1), var(--bg2));
    overflow-x: hidden;
  }

  .topbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 10px 12px calc(10px + env(safe-area-inset-top));
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    z-index: 50;
    backdrop-filter: blur(10px);
    background: rgba(0,0,0,0.14);
    border-bottom: 1px solid rgba(255,255,255,0.10);
  }

  .pill {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 8px 10px;
    border-radius: 16px;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.14);
  }

  .label {
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 0.02em;
  }

  input[type="number"] {
    width: 58px;
    padding: 6px 8px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(0,0,0,0.18);
    color: var(--text);
    font-weight: 700;
    outline: none;
  }

  input[type="range"] {
    width: 160px;
    accent-color: rgba(255,255,255,0.92);
  }

  .tiny {
    font-size: 12px;
    color: var(--muted);
    min-width: 34px;
    text-align: right;
  }

  .tgroup {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .tbtn {
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.10);
    color: var(--text);
    padding: 8px 10px;
    border-radius: 14px;
    font-weight: 800;
    font-size: 14px;
    line-height: 1;
    cursor: pointer;
    user-select: none;
    transition: transform 80ms ease, background 120ms ease, border-color 120ms ease;
  }
  .tbtn:active { transform: scale(0.98); }
  .tbtn.active {
    background: rgba(255,255,255,0.22);
    border-color: rgba(255,255,255,0.30);
  }

  .iconbtn {
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.12);
    color: var(--text);
    width: 40px;
    height: 40px;
    border-radius: 14px;
    cursor: pointer;
    user-select: none;
  }
  .iconbtn:active { transform: scale(0.98); }
  .iconbtn.disabled {
    opacity: 0.45;
    pointer-events: none;
  }

  .stage {
    min-height: 100vh;
    min-height: 100dvh;
    padding-top: calc(var(--topbar-h) + 16px);
    padding-bottom: calc(18px + env(safe-area-inset-bottom));
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .card {
    width: min(1040px, 96vw);
    border-radius: var(--radius);
    background: rgba(0,0,0,0.20);
    border: 1px solid rgba(255,255,255,0.12);
    box-shadow: var(--shadow);
    padding: 16px;
    display: grid;
    gap: 14px;
  }

  .frame {
    width: 100%;
    height: min(56dvh, 540px);
    height: min(56vh, 540px);
    min-height: 280px;
    border-radius: 18px;
    background: #000;
    border: 1px solid rgba(255,255,255,0.14);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
    padding: 16px;
  }

  .frame img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    display: block;
  }
  .frame img.hidden {
    opacity: 0;
    visibility: hidden;
  }

  .mask {
    position: absolute;
    inset: 0;
    background: #000;
    opacity: 0;
    pointer-events: none;
    z-index: 2;
  }
  .mask.visible {
    opacity: 1;
  }

  .pad {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
  }

  .num {
    border: 1px solid rgba(255,255,255,0.22);
    background: rgba(255,255,255,0.18);
    color: var(--text);
    border-radius: 16px;
    padding: 14px 0;
    font-size: 22px;
    font-weight: 900;
    cursor: pointer;
    user-select: none;
  }
  .num:active { transform: scale(0.99); }
  .num.disabled {
    opacity: 0.35;
    pointer-events: none;
  }

  .feedback {
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 120ms ease;
    z-index: 80;
  }
  .feedback.visible {
    opacity: 1;
  }
  .result {
    display: grid;
    place-items: center;
    gap: 10px;
    padding: 16px 18px;
    border-radius: 18px;
    background: rgba(0,0,0,0.36);
    border: 1px solid rgba(255,255,255,0.16);
    backdrop-filter: blur(8px);
  }
  .emoji {
    font-size: 56px;
    line-height: 1;
  }
  .bign {
    font-size: 44px;
    font-weight: 900;
    letter-spacing: 0.02em;
  }

  @media (max-width: 720px) {
    :root { --topbar-h: 112px; }
    input[type="range"] { width: 120px; }
    .pad { grid-template-columns: repeat(5, 1fr); }
  }

  @media (max-width: 420px) {
    :root { --topbar-h: 132px; }
    .pad { grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .num { padding: 12px 0; font-size: 20px; }
  }
</style>
</head>
<body>

<div class="topbar" id="topbar">
  <div class="pill">
    <span class="label">min</span>
    <input type="number" id="minTotal" value="1" min="0" max="20"/>
    <span class="label">max</span>
    <input type="number" id="maxTotal" value="10" min="0" max="20"/>
  </div>

  <div class="pill">
    <span class="label">stenen</span>
    <div class="tgroup" id="diceCountGroup">
      <button class="tbtn active" data-c="1" title="1 dobbelsteen">1</button>
      <button class="tbtn active" data-c="2" title="2 dobbelstenen">2</button>
    </div>
  </div>

  <div class="pill">
    <span class="label">mix</span>
    <div class="tgroup" id="filterGroup">
      <button class="tbtn" data-f="diff1" title="1 meer">+1</button>
      <button class="tbtn" data-f="diff2" title="2 meer">+2</button>
      <button class="tbtn" data-f="equal" title="gelijken">=</button>
      <button class="tbtn" data-f="first" title="grootste links">1&gt;2</button>
      <button class="tbtn" data-f="second" title="grootste rechts">2&gt;1</button>
    </div>
  </div>

  <div class="pill">
    <span class="label">flits</span>
    <input type="range" id="flashMs" min="150" max="2500" step="50" value="800"/>
    <span class="tiny" id="flashLabel">800</span>
  </div>

  <button class="iconbtn" id="startBtn" title="start of herstart">‚ñ∂Ô∏è</button>
  <button class="iconbtn" id="revealBtn" title="nog een keer dezelfde">üëÄ</button>
  <button class="iconbtn" id="fsBtn" title="volledig scherm">‚õ∂</button>
</div>

<div class="stage">
  <div class="card">
    <div class="frame" id="frame">
      <img id="diceImg" alt=""/>
      <div class="mask" id="mask"></div>
    </div>

    <div class="pad" id="pad"></div>
  </div>
</div>

<div class="feedback" id="feedback">
  <div class="result">
    <div class="emoji" id="emoji"></div>
    <div class="bign" id="bign"></div>
  </div>
</div>

<script>
const RAW_ITEMS = [{"src": "assets/images/dobbelsteen01a.png", "total": 1, "nDice": 1, "d1": 1, "d2": null, "name": "dobbelsteen01a.png"}, {"src": "assets/images/dobbelsteen02a.png", "total": 2, "nDice": 1, "d1": 2, "d2": null, "name": "dobbelsteen02a.png"}, {"src": "assets/images/dobbelsteen02b.png", "total": 2, "nDice": 2, "d1": 1, "d2": 1, "name": "dobbelsteen02b.png"}, {"src": "assets/images/dobbelsteen03a.png", "total": 3, "nDice": 1, "d1": 3, "d2": null, "name": "dobbelsteen03a.png"}, {"src": "assets/images/dobbelsteen03b.png", "total": 3, "nDice": 2, "d1": 1, "d2": 2, "name": "dobbelsteen03b.png"}, {"src": "assets/images/dobbelsteen03c.png", "total": 3, "nDice": 2, "d1": 2, "d2": 1, "name": "dobbelsteen03c.png"}, {"src": "assets/images/dobbelsteen04a.png", "total": 4, "nDice": 1, "d1": 4, "d2": null, "name": "dobbelsteen04a.png"}, {"src": "assets/images/dobbelsteen04b.png", "total": 4, "nDice": 2, "d1": 1, "d2": 3, "name": "dobbelsteen04b.png"}, {"src": "assets/images/dobbelsteen04c.png", "total": 4, "nDice": 2, "d1": 2, "d2": 2, "name": "dobbelsteen04c.png"}, {"src": "assets/images/dobbelsteen04d.png", "total": 4, "nDice": 2, "d1": 3, "d2": 1, "name": "dobbelsteen04d.png"}, {"src": "assets/images/dobbelsteen05a.png", "total": 5, "nDice": 1, "d1": 5, "d2": null, "name": "dobbelsteen05a.png"}, {"src": "assets/images/dobbelsteen05b.png", "total": 5, "nDice": 2, "d1": 1, "d2": 4, "name": "dobbelsteen05b.png"}, {"src": "assets/images/dobbelsteen05c.png", "total": 5, "nDice": 2, "d1": 2, "d2": 3, "name": "dobbelsteen05c.png"}, {"src": "assets/images/dobbelsteen05d.png", "total": 5, "nDice": 2, "d1": 3, "d2": 2, "name": "dobbelsteen05d.png"}, {"src": "assets/images/dobbelsteen05e.png", "total": 5, "nDice": 2, "d1": 4, "d2": 1, "name": "dobbelsteen05e.png"}, {"src": "assets/images/dobbelsteen06a.png", "total": 6, "nDice": 1, "d1": 6, "d2": null, "name": "dobbelsteen06a.png"}, {"src": "assets/images/dobbelsteen06b.png", "total": 6, "nDice": 2, "d1": 1, "d2": 5, "name": "dobbelsteen06b.png"}, {"src": "assets/images/dobbelsteen06c.png", "total": 6, "nDice": 2, "d1": 2, "d2": 4, "name": "dobbelsteen06c.png"}, {"src": "assets/images/dobbelsteen06d.png", "total": 6, "nDice": 2, "d1": 3, "d2": 3, "name": "dobbelsteen06d.png"}, {"src": "assets/images/dobbelsteen06e.png", "total": 6, "nDice": 2, "d1": 4, "d2": 2, "name": "dobbelsteen06e.png"}, {"src": "assets/images/dobbelsteen06f.png", "total": 6, "nDice": 2, "d1": 5, "d2": 1, "name": "dobbelsteen06f.png"}, {"src": "assets/images/dobbelsteen07a.png", "total": 7, "nDice": 2, "d1": 1, "d2": 6, "name": "dobbelsteen07a.png"}, {"src": "assets/images/dobbelsteen07b.png", "total": 7, "nDice": 2, "d1": 2, "d2": 5, "name": "dobbelsteen07b.png"}, {"src": "assets/images/dobbelsteen07c.png", "total": 7, "nDice": 2, "d1": 5, "d2": 2, "name": "dobbelsteen07c.png"}, {"src": "assets/images/dobbelsteen07d.png", "total": 7, "nDice": 2, "d1": 6, "d2": 1, "name": "dobbelsteen07d.png"}, {"src": "assets/images/dobbelsteen08a.png", "total": 8, "nDice": 2, "d1": 2, "d2": 6, "name": "dobbelsteen08a.png"}, {"src": "assets/images/dobbelsteen08b.png", "total": 8, "nDice": 2, "d1": 4, "d2": 4, "name": "dobbelsteen08b.png"}, {"src": "assets/images/dobbelsteen08c.png", "total": 8, "nDice": 2, "d1": 6, "d2": 2, "name": "dobbelsteen08c.png"}, {"src": "assets/images/dobbelsteen09a.png", "total": 9, "nDice": 2, "d1": 4, "d2": 5, "name": "dobbelsteen09a.png"}, {"src": "assets/images/dobbelsteen09b.png", "total": 9, "nDice": 2, "d1": 5, "d2": 4, "name": "dobbelsteen09b.png"}, {"src": "assets/images/dobbelsteen10.png", "total": 10, "nDice": 2, "d1": 5, "d2": 5, "name": "dobbelsteen10.png"}];

const $ = (id) => document.getElementById(id);
const minTotal = $("minTotal");
const maxTotal = $("maxTotal");
const flashMs = $("flashMs");
const flashLabel = $("flashLabel");
const startBtn = $("startBtn");
const revealBtn = $("revealBtn");
const fsBtn = $("fsBtn");

const diceImg = $("diceImg");
const mask = $("mask");
const pad = $("pad");
const feedback = $("feedback");
const emoji = $("emoji");
const bign = $("bign");

const filterGroup = $("filterGroup");
const diceCountGroup = $("diceCountGroup");

let ALL_ITEMS = [];
let current = null;
let awaiting = false;
let running = false;
let bag = [];
let buckets = new Map();
let recent = [];
let lastKey = "";
let attempt = 0;

function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function getActiveFilters() {
  const set = new Set();
  filterGroup.querySelectorAll(".tbtn.active").forEach(b => set.add(b.dataset.f));
  return set;
}

function getDiceCount() {
  const on = new Set();
  diceCountGroup.querySelectorAll(".tbtn.active").forEach(b => on.add(Number(b.dataset.c)));
  if (on.size === 0) {
    diceCountGroup.querySelectorAll(".tbtn").forEach(b => b.classList.add("active"));
    on.add(1); on.add(2);
  }
  return on;
}

function matchesAnyFilter(item, fset) {
  if (fset.size === 0) return true;
  if (item.nDice !== 2) return false;
  const a = item.d1;
  const b = item.d2;
  const rules = {
    diff1: Math.abs(a - b) === 1,
    diff2: Math.abs(a - b) === 2,
    equal: a === b,
    first: a > b,
    second: b > a
  };
  for (const f of fset) {
    if (rules[f]) return true;
  }
  return false;
}

function settingsKey() {
  const minT = clamp(parseInt(minTotal.value || "0", 10), 0, 20);
  const maxT = clamp(parseInt(maxTotal.value || "10", 10), 0, 20);
  const f = Array.from(getActiveFilters()).sort().join(",");
  const d = Array.from(getDiceCount()).sort().join(",");
  return `${minT}|${maxT}|${f}|${d}|${ALL_ITEMS.length}`;
}

function buildBuckets() {
  const minT = clamp(parseInt(minTotal.value || "0", 10), 0, 20);
  const maxT = clamp(parseInt(maxTotal.value || "10", 10), 0, 20);
  if (minT > maxT) {
    minTotal.value = String(maxT);
  }

  const fset = getActiveFilters();
  const diceOn = getDiceCount();

  const temp = new Map();

  for (const it of ALL_ITEMS) {
    if (it.total < minT || it.total > maxT) continue;
    if (!diceOn.has(it.nDice)) continue;
    if (!matchesAnyFilter(it, fset)) continue;
    const k = it.total;
    if (!temp.has(k)) temp.set(k, []);
    temp.get(k).push(it);
  }

  if (temp.size === 0) {
    // eerste fallback, filters loslaten
    for (const it of ALL_ITEMS) {
      if (it.total < minT || it.total > maxT) continue;
      if (!diceOn.has(it.nDice)) continue;
      const k = it.total;
      if (!temp.has(k)) temp.set(k, []);
      temp.get(k).push(it);
    }
  }

  if (temp.size === 0) {
    // laatste fallback, alles
    for (const it of ALL_ITEMS) {
      const k = it.total;
      if (!temp.has(k)) temp.set(k, []);
      temp.get(k).push(it);
    }
  }

  buckets = temp;

  const totals = Array.from(buckets.keys()).sort((a,b)=>a-b);
  bag = shuffle(totals.slice());
}

function pickNextItem() {
  const key = settingsKey();
  if (key !== lastKey || bag.length === 0) {
    lastKey = key;
    buildBuckets();
  }

  if (bag.length === 0) buildBuckets();

  let total = bag.pop();
  if (!buckets.has(total) || buckets.get(total).length === 0) {
    buildBuckets();
    total = bag.pop();
  }

  const list = buckets.get(total) || [];
  const fresh = list.filter(it => !recent.includes(it.src));
  const pool = (fresh.length > 0) ? fresh : list;

  const chosen = pool[Math.floor(Math.random() * pool.length)];
  return chosen;
}

function setPadEnabled(enabled) {
  pad.querySelectorAll("button").forEach(btn => {
    btn.classList.toggle("disabled", !enabled);
    btn.disabled = !enabled;
  });
}

function updatePadAvailability() {
  const minT = clamp(parseInt(minTotal.value || "0", 10), 0, 20);
  const maxT = clamp(parseInt(maxTotal.value || "10", 10), 0, 20);
  pad.querySelectorAll("button").forEach(btn => {
    const n = Number(btn.dataset.n);
    const inRange = (n >= minT && n <= maxT);
    btn.classList.toggle("disabled", !inRange || !awaiting);
    btn.disabled = !inRange || !awaiting;
  });
}

function showFeedback(ok, correctTotal) {
  emoji.textContent = ok ? "üéâ" : "üòÖ";
  bign.textContent = ok ? String(correctTotal) : "";
  feedback.classList.add("visible");
}

function hideFeedback() {
  feedback.classList.remove("visible");
}

function showDice() {
  diceImg.classList.remove("hidden");
  mask.classList.remove("visible");
}

function hideDice() {
  diceImg.classList.add("hidden");
  mask.classList.add("visible");
}

function sleep(ms) {
  return new Promise(res => setTimeout(res, ms));
}

async function flashItem(item) {
  current = item;
  awaiting = false;
  attempt = 0;
  updatePadAvailability();

  diceImg.src = item.src;
  showDice();

  const ms = clamp(parseInt(flashMs.value || "800", 10), 150, 2500);
  await sleep(ms);

  hideDice();
  awaiting = true;
  updatePadAvailability();
}

async function reflashSame() {
  if (!current) return;
  awaiting = false;
  updatePadAvailability();
  showDice();
  const ms = clamp(parseInt(flashMs.value || "800", 10), 150, 2500);
  await sleep(ms);
  hideDice();
  awaiting = true;
  updatePadAvailability();
}

async function nextRound() {
  if (!running) return;

  const item = pickNextItem();
  if (!item) return;

  recent.unshift(item.src);
  if (recent.length > 8) recent.pop();

  await flashItem(item);
}

async function onAnswer(n) {
  if (!awaiting || !current) return;

  awaiting = false;
  updatePadAvailability();

  const ok = (n === current.total);
  if (ok) {
    showFeedback(true, current.total);
    await sleep(850);
    hideFeedback();
    await sleep(120);
    await nextRound();
    return;
  }

  attempt += 1;
  showFeedback(false, current.total);
  await sleep(650);
  hideFeedback();
  await sleep(120);
  await reflashSame();
}

function buildPad() {
  pad.innerHTML = "";
  for (let n = 1; n <= 10; n++) {
    const b = document.createElement("button");
    b.className = "num";
    b.textContent = String(n);
    b.dataset.n = String(n);
    b.addEventListener("click", () => onAnswer(n));
    pad.appendChild(b);
  }
}

async function validateAssets(items) {
  const ok = [];
  await Promise.all(items.map(it => new Promise(resolve => {
    const im = new Image();
    im.onload = () => { ok.push(it); resolve(); };
    im.onerror = () => resolve();
    im.src = it.src;
  })));
  return ok;
}

function wireToggles() {
  function toggle(btn) {
    btn.classList.toggle("active");
    lastKey = "";
    if (running && current) {
      // nieuwe instellingen, volgende ronde past zich aan
    }
  }

  filterGroup.querySelectorAll(".tbtn").forEach(b => {
    b.addEventListener("click", () => toggle(b));
  });

  diceCountGroup.querySelectorAll(".tbtn").forEach(b => {
    b.addEventListener("click", () => {
      toggle(b);
      getDiceCount();
    });
  });
}

flashMs.addEventListener("input", () => {
  flashLabel.textContent = String(flashMs.value);
});

function setStartReady(ready) {
  startBtn.classList.toggle("disabled", !ready);
}

startBtn.addEventListener("click", async () => {
  if (!ALL_ITEMS.length) return;
  running = true;
  hideFeedback();
  hideDice();
  await sleep(80);
  await nextRound();
});

revealBtn.addEventListener("click", async () => {
  if (!running || !current) return;
  await reflashSame();
});

fsBtn.addEventListener("click", async () => {
  try {
    if (!document.fullscreenElement) {
      await document.documentElement.requestFullscreen();
    } else {
      await document.exitFullscreen();
    }
  } catch (e) {}
});

[minTotal, maxTotal].forEach(inp => inp.addEventListener("input", () => {
  lastKey = "";
  if (running) updatePadAvailability();
}));

diceImg.addEventListener("error", () => {
  if (!current) return;
  ALL_ITEMS = ALL_ITEMS.filter(it => it.src !== current.src);
  lastKey = "";
  if (running) nextRound();
});

(async function init() {
  buildPad();
  wireToggles();
  flashLabel.textContent = String(flashMs.value);
  hideDice();
  setStartReady(false);

  // voor GitHub Pages, skip ontbrekende plaatjes voordat je start
  ALL_ITEMS = await validateAssets(RAW_ITEMS);

  setStartReady(ALL_ITEMS.length > 0);
  lastKey = "";
  updatePadAvailability();
})();
</script>
</body>
</html>
