<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Dobbelstenen flits</title>
<style>
  :root {
    --bg1: #6a11cb;
    --bg2: #2575fc;
    --glass: rgba(255,255,255,0.12);
    --glass2: rgba(255,255,255,0.18);
    --text: rgba(255,255,255,0.96);
    --muted: rgba(255,255,255,0.78);
    --shadow: 0 18px 45px rgba(0,0,0,0.25);
    --radius: 22px;
    --topbar-h: 72px;
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color: var(--text);
    background:
      radial-gradient(900px 500px at 20% 10%, rgba(255,255,255,0.18), transparent 55%),
      linear-gradient(135deg, var(--bg1), var(--bg2));
    overflow-x: hidden;
  }

  .topbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: calc(10px + env(safe-area-inset-top)) 12px 10px 12px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    z-index: 50;
    backdrop-filter: blur(10px);
    background: rgba(0,0,0,0.14);
    border-bottom: 1px solid rgba(255,255,255,0.10);
  }

  .pill {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 8px 10px;
    border-radius: 16px;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.14);
  }

  .label {
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 0.02em;
    user-select: none;
  }

  input[type="number"] {
    width: 58px;
    padding: 6px 8px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(0,0,0,0.18);
    color: var(--text);
    font-weight: 700;
    outline: none;
  }

  input[type="range"] {
    width: 160px;
    accent-color: rgba(255,255,255,0.92);
  }

  .tiny {
    font-size: 12px;
    color: var(--muted);
    min-width: 36px;
    text-align: right;
    user-select: none;
  }

  .tgroup {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .tbtn {
    border: 0;
    outline: none;
    padding: 8px 10px;
    border-radius: 14px;
    cursor: pointer;
    background: rgba(0,0,0,0.18);
    color: rgba(255,255,255,0.92);
    font-weight: 800;
    letter-spacing: 0.02em;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12);
    user-select: none;
  }
  .tbtn.active {
    background: rgba(255,255,255,0.18);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.24);
  }
  .tbtn:active {
    transform: translateY(1px);
  }

  .iconbtn {
    border: 0;
    outline: none;
    width: 44px;
    height: 40px;
    border-radius: 14px;
    cursor: pointer;
    background: rgba(0,0,0,0.18);
    color: rgba(255,255,255,0.92);
    font-weight: 900;
    display: grid;
    place-items: center;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12);
  }
  .iconbtn.primary {
    background: rgba(255,255,255,0.20);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.22);
  }

  .wrap {
    min-height: 100%;
    padding-top: calc(var(--topbar-h) + 18px);
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    display: grid;
    place-items: start center;
  }

  .panel {
    width: min(980px, 94vw);
    padding: 16px;
    border-radius: var(--radius);
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.14);
    box-shadow: var(--shadow);
  }

  .frame {
    width: 100%;
    height: min(52svh, 540px);
    min-height: 260px;
    border-radius: 18px;
    background: #000;
    border: 1px solid rgba(255,255,255,0.14);
    overflow: hidden;
    position: relative;
  }

  .stage {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: clamp(10px, 2.2vw, 22px);
  }

  #diceImg {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    display: block;
  }
  #diceImg.hidden {
    opacity: 0;
    visibility: hidden;
  }

  .mask {
    position: absolute;
    inset: 0;
    background: #000;
    opacity: 1;
    pointer-events: none;
    z-index: 3;
    transition: opacity 140ms ease;
  }
  .mask.off {
    opacity: 0;
  }

  .pad {
    margin-top: 14px;
    display: grid;
    grid-template-columns: repeat(10, minmax(0, 1fr));
    gap: 10px;
  }

  .nbtn {
    border: 0;
    outline: none;
    border-radius: 16px;
    padding: 14px 0;
    font-size: 20px;
    font-weight: 900;
    cursor: pointer;
    background: rgba(0,0,0,0.20);
    color: rgba(255,255,255,0.94);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.14);
    user-select: none;
  }
  .nbtn:active {
    transform: translateY(1px);
  }
  .nbtn.disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .feedback {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    z-index: 6;
    pointer-events: none;
    opacity: 0;
    transition: opacity 120ms ease;
  }
  .feedback.on {
    opacity: 1;
  }
  .fbInner {
    display: grid;
    place-items: center;
    gap: 10px;
    padding: 18px 22px;
    border-radius: 22px;
    background: rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.14);
    backdrop-filter: blur(8px);
  }
  .emoji {
    font-size: 52px;
    line-height: 1;
  }
  .bign {
    font-size: 52px;
    font-weight: 950;
    line-height: 1;
  }

  @media (max-width: 720px) {
    input[type="range"] { width: 140px; }
    .pad { grid-template-columns: repeat(5, minmax(0, 1fr)); }
  }
</style>
</head>
<body>
  <div class="topbar" id="topbar">
    <div class="pill">
      <span class="label">min</span>
      <input id="minTotal" type="number" value="1" min="0" max="20"/>
      <span class="label">max</span>
      <input id="maxTotal" type="number" value="10" min="0" max="20"/>
    </div>

    <div class="pill">
      <span class="label">stenen</span>
      <div class="tgroup" id="diceCountGroup">
        <button class="tbtn active" data-c="1" title="1 dobbelsteen">1</button>
        <button class="tbtn active" data-c="2" title="2 dobbelstenen">2</button>
      </div>
    </div>

    <div class="pill">
      <span class="label">mix</span>
      <div class="tgroup" id="typeGroup">
        <button class="tbtn" data-t="diff1" title="minstens Ã©Ã©n dobbelsteen is 1">+1</button>
        <button class="tbtn" data-t="diff2" title="minstens Ã©Ã©n dobbelsteen is 2">+2</button>
      </div>
    </div>

    <div class="pill">
      <span class="label">vergelijk</span>
      <div class="tgroup" id="relGroup">
        <button class="tbtn" data-r="equal" title="gelijken">=</button>
        <button class="tbtn" data-r="first" title="eerste is groter">1&gt;2</button>
        <button class="tbtn" data-r="second" title="tweede is groter">2&gt;1</button>
      </div>
    </div>

    <div class="pill">
      <span class="label">flits</span>
      <input id="flashMs" type="range" min="150" max="2200" value="800" step="50"/>
      <span class="tiny" id="flashLabel">800</span>
    </div>

    <button class="iconbtn primary" id="startBtn" title="start of pauze">â–¶</button>
    <button class="iconbtn" id="fsBtn" title="volledig scherm">â›¶</button>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="frame">
        <div class="stage">
          <img id="diceImg" class="hidden" alt=""/>
          <div class="mask" id="mask"></div>
          <div class="feedback" id="feedback">
            <div class="fbInner">
              <div class="emoji" id="emoji"></div>
              <div class="bign" id="bign"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="pad" id="pad" aria-label="antwoorden"></div>
    </div>
  </div>

<script>
const RAW_ITEMS = [{"src": "assets/images/dobbelsteen01a.png", "total": 1, "nDice": 1, "d1": 1, "d2": null, "name": "dobbelsteen01a.png"}, {"src": "assets/images/dobbelsteen02a.png", "total": 2, "nDice": 1, "d1": 2, "d2": null, "name": "dobbelsteen02a.png"}, {"src": "assets/images/dobbelsteen02b.png", "total": 2, "nDice": 2, "d1": 1, "d2": 1, "name": "dobbelsteen02b.png"}, {"src": "assets/images/dobbelsteen03a.png", "total": 3, "nDice": 1, "d1": 3, "d2": null, "name": "dobbelsteen03a.png"}, {"src": "assets/images/dobbelsteen03b.png", "total": 3, "nDice": 2, "d1": 1, "d2": 2, "name": "dobbelsteen03b.png"}, {"src": "assets/images/dobbelsteen03c.png", "total": 3, "nDice": 2, "d1": 2, "d2": 1, "name": "dobbelsteen03c.png"}, {"src": "assets/images/dobbelsteen04a.png", "total": 4, "nDice": 1, "d1": 4, "d2": null, "name": "dobbelsteen04a.png"}, {"src": "assets/images/dobbelsteen04b.png", "total": 4, "nDice": 2, "d1": 1, "d2": 3, "name": "dobbelsteen04b.png"}, {"src": "assets/images/dobbelsteen04c.png", "total": 4, "nDice": 2, "d1": 2, "d2": 2, "name": "dobbelsteen04c.png"}, {"src": "assets/images/dobbelsteen04d.png", "total": 4, "nDice": 2, "d1": 3, "d2": 1, "name": "dobbelsteen04d.png"}, {"src": "assets/images/dobbelsteen05a.png", "total": 5, "nDice": 1, "d1": 5, "d2": null, "name": "dobbelsteen05a.png"}, {"src": "assets/images/dobbelsteen05b.png", "total": 5, "nDice": 2, "d1": 1, "d2": 4, "name": "dobbelsteen05b.png"}, {"src": "assets/images/dobbelsteen05c.png", "total": 5, "nDice": 2, "d1": 2, "d2": 3, "name": "dobbelsteen05c.png"}, {"src": "assets/images/dobbelsteen05d.png", "total": 5, "nDice": 2, "d1": 3, "d2": 2, "name": "dobbelsteen05d.png"}, {"src": "assets/images/dobbelsteen05e.png", "total": 5, "nDice": 2, "d1": 4, "d2": 1, "name": "dobbelsteen05e.png"}, {"src": "assets/images/dobbelsteen06a.png", "total": 6, "nDice": 1, "d1": 6, "d2": null, "name": "dobbelsteen06a.png"}, {"src": "assets/images/dobbelsteen06b.png", "total": 6, "nDice": 2, "d1": 1, "d2": 5, "name": "dobbelsteen06b.png"}, {"src": "assets/images/dobbelsteen06c.png", "total": 6, "nDice": 2, "d1": 2, "d2": 4, "name": "dobbelsteen06c.png"}, {"src": "assets/images/dobbelsteen06d.png", "total": 6, "nDice": 2, "d1": 3, "d2": 3, "name": "dobbelsteen06d.png"}, {"src": "assets/images/dobbelsteen06e.png", "total": 6, "nDice": 2, "d1": 4, "d2": 2, "name": "dobbelsteen06e.png"}, {"src": "assets/images/dobbelsteen06f.png", "total": 6, "nDice": 2, "d1": 5, "d2": 1, "name": "dobbelsteen06f.png"}, {"src": "assets/images/dobbelsteen07a.png", "total": 7, "nDice": 2, "d1": 1, "d2": 6, "name": "dobbelsteen07a.png"}, {"src": "assets/images/dobbelsteen07b.png", "total": 7, "nDice": 2, "d1": 2, "d2": 5, "name": "dobbelsteen07b.png"}, {"src": "assets/images/dobbelsteen07c.png", "total": 7, "nDice": 2, "d1": 5, "d2": 2, "name": "dobbelsteen07c.png"}, {"src": "assets/images/dobbelsteen07d.png", "total": 7, "nDice": 2, "d1": 6, "d2": 1, "name": "dobbelsteen07d.png"}, {"src": "assets/images/dobbelsteen08a.png", "total": 8, "nDice": 2, "d1": 2, "d2": 6, "name": "dobbelsteen08a.png"}, {"src": "assets/images/dobbelsteen08b.png", "total": 8, "nDice": 2, "d1": 4, "d2": 4, "name": "dobbelsteen08b.png"}, {"src": "assets/images/dobbelsteen08c.png", "total": 8, "nDice": 2, "d1": 6, "d2": 2, "name": "dobbelsteen08c.png"}, {"src": "assets/images/dobbelsteen09a.png", "total": 9, "nDice": 2, "d1": 4, "d2": 5, "name": "dobbelsteen09a.png"}, {"src": "assets/images/dobbelsteen09b.png", "total": 9, "nDice": 2, "d1": 5, "d2": 4, "name": "dobbelsteen09b.png"}, {"src": "assets/images/dobbelsteen10.png", "total": 10, "nDice": 2, "d1": 5, "d2": 5, "name": "dobbelsteen10.png"}];

const $ = (id) => document.getElementById(id);

const topbar = $("topbar");
const minTotal = $("minTotal");
const maxTotal = $("maxTotal");
const diceCountGroup = $("diceCountGroup");
const typeGroup = $("typeGroup");
const relGroup = $("relGroup");
const flashMs = $("flashMs");
const flashLabel = $("flashLabel");
const startBtn = $("startBtn");
const fsBtn = $("fsBtn");

const diceImg = $("diceImg");
const mask = $("mask");
const pad = $("pad");
const feedback = $("feedback");
const emoji = $("emoji");
const bign = $("bign");

let ALL_ITEMS = [];
let current = null;
let awaiting = false;
let running = false;
let bag = [];
let buckets = new Map();
let recent = [];
let lastKey = "";
let attempt = 0;

function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function syncTopbarHeight() {
  const h = topbar.offsetHeight || 72;
  document.documentElement.style.setProperty("--topbar-h", h + "px");
}

function getDiceCount() {
  const on = new Set();
  diceCountGroup.querySelectorAll(".tbtn.active").forEach(b => on.add(Number(b.dataset.c)));
  if (on.size === 0) {
    diceCountGroup.querySelectorAll(".tbtn").forEach(b => b.classList.add("active"));
    on.add(1); on.add(2);
  }
  return on;
}

function getTypes() {
  const set = new Set();
  typeGroup.querySelectorAll(".tbtn.active").forEach(b => set.add(b.dataset.t));
  return set;
}

function getRels() {
  const set = new Set();
  relGroup.querySelectorAll(".tbtn.active").forEach(b => set.add(b.dataset.r));
  return set;
}

function relOk(it, rels) {
  if (rels.size === 0) return true;
  const a = it.d1, b = it.d2;
  return (rels.has("equal") && a === b) ||
         (rels.has("first") && a > b) ||
         (rels.has("second") && b > a);
}

function matchContainsNumberOnSmallerSide(it, n, rels) {
  const a = it.d1, b = it.d2;
  if (rels.size === 0) return (a === n || b === n);

  let ok = false;
  if (rels.has("equal") && a === b && a === n) ok = true;
  if (rels.has("first") && a > b && b === n) ok = true;   // tweede is kleiner
  if (rels.has("second") && b > a && a === n) ok = true;  // eerste is kleiner
  return ok;
}

function typeOk(it, types, rels) {
  if (types.size === 0) return true;
  for (const t of types) {
    if (t === "diff1" && matchContainsNumberOnSmallerSide(it, 1, rels)) return true;
    if (t === "diff2" && matchContainsNumberOnSmallerSide(it, 2, rels)) return true;
  }
  return false;
}

function itemEligible(it, minT, maxT, diceOn, types, rels) {
  if (it.total < minT || it.total > maxT) return false;

  // als er mix of vergelijken aan staat, dan alleen 2 dobbelstenen
  if ((types.size > 0 || rels.size > 0) && it.nDice !== 2) return false;

  if (!diceOn.has(it.nDice)) return false;
  if (!relOk(it, rels)) return false;
  if (!typeOk(it, types, rels)) return false;

  return true;
}

function settingsKey() {
  const minT = clamp(parseInt(minTotal.value || "0", 10), 0, 20);
  const maxT = clamp(parseInt(maxTotal.value || "10", 10), 0, 20);
  const diceOn = Array.from(getDiceCount()).sort().join("");
  const types = Array.from(getTypes()).sort().join(",");
  const rels = Array.from(getRels()).sort().join(",");
  const ms = flashMs.value;
  return [minT, maxT, diceOn, types, rels, ms].join("|");
}

function buildBuckets() {
  const minT = clamp(parseInt(minTotal.value || "0", 10), 0, 20);
  const maxT = clamp(parseInt(maxTotal.value || "10", 10), 0, 20);
  if (minT > maxT) minTotal.value = String(maxT);

  const diceOn = getDiceCount();
  const types = getTypes();
  const rels = getRels();

  // als er mix of vergelijken aan staat, zet 2 aan (zodat je niet per ongeluk leeg speelt)
  if ((types.size > 0 || rels.size > 0) && !diceOn.has(2)) {
    const b2 = diceCountGroup.querySelector('[data-c="2"]');
    if (b2) b2.classList.add("active");
    diceOn.add(2);
  }

  const temp = new Map();
  for (const it of ALL_ITEMS) {
    if (!itemEligible(it, minT, maxT, diceOn, types, rels)) continue;
    const k = it.total;
    if (!temp.has(k)) temp.set(k, []);
    temp.get(k).push(it);
  }

  // geen items, dan maak de selectie wat ruimer, maar blijf bij 2 dobbelstenen als dat logisch is
  if (temp.size === 0) {
    for (const it of ALL_ITEMS) {
      if (it.total < minT || it.total > maxT) continue;
      if ((types.size > 0 || rels.size > 0) && it.nDice !== 2) continue;
      if (!diceOn.has(it.nDice)) continue;
      const k = it.total;
      if (!temp.has(k)) temp.set(k, []);
      temp.get(k).push(it);
    }
  }

  buckets = temp;
  const totals = Array.from(buckets.keys()).sort((a,b)=>a-b);
  bag = shuffle(totals.slice());
}

function pickNextItem() {
  const key = settingsKey();
  if (key !== lastKey || bag.length === 0) {
    lastKey = key;
    buildBuckets();
  }
  if (bag.length === 0) buildBuckets();
  let total = bag.pop();
  if (!buckets.has(total) || buckets.get(total).length === 0) {
    buildBuckets();
    total = bag.pop();
  }

  const list = buckets.get(total) || [];
  const fresh = list.filter(it => !recent.includes(it.src));
  const pool = fresh.length ? fresh : list;
  const chosen = pool[Math.floor(Math.random() * pool.length)];
  return chosen;
}

function wait(ms) {
  return new Promise(r => setTimeout(r, ms));
}

function showDice(item) {
  diceImg.src = item.src;
  diceImg.classList.remove("hidden");
  mask.classList.add("off");
}

function hideDice() {
  mask.classList.remove("off");     // zwart vlak aan
  diceImg.classList.add("hidden");  // zekerheid, ook bij traag laden
}

function hideFeedback() {
  feedback.classList.remove("on");
  emoji.textContent = "";
  bign.textContent = "";
}

function showFeedback(ok, correctTotal) {
  emoji.textContent = ok ? "ðŸŽ‰" : "ðŸ˜…";
  bign.textContent = ok ? String(correctTotal) : "";
  feedback.classList.add("on");
}

function buildPad() {
  pad.innerHTML = "";
  for (let i = 1; i <= 10; i++) {
    const b = document.createElement("button");
    b.className = "nbtn";
    b.textContent = String(i);
    b.dataset.n = String(i);
    b.addEventListener("click", () => handleAnswer(i));
    pad.appendChild(b);
  }
}

function updatePadAvailability() {
  const minT = clamp(parseInt(minTotal.value || "0", 10), 0, 20);
  const maxT = clamp(parseInt(maxTotal.value || "10", 10), 0, 20);
  pad.querySelectorAll("button").forEach(btn => {
    const n = Number(btn.dataset.n);
    const inRange = (n >= minT && n <= maxT);
    const enabled = inRange && awaiting;
    btn.classList.toggle("disabled", !enabled);
    btn.disabled = !enabled;
  });
}

async function flashItem(item) {
  awaiting = false;
  updatePadAvailability();
  hideFeedback();

  showDice(item);
  await wait(Number(flashMs.value));
  hideDice();

  awaiting = true;
  updatePadAvailability();
}

async function nextRound() {
  if (!running) return;
  current = pickNextItem();
  attempt = 0;
  recent.push(current.src);
  if (recent.length > 8) recent.shift();
  await flashItem(current);
}

async function replaySame() {
  if (!running || !current) return;
  attempt += 1;
  await flashItem(current);
}

async function handleAnswer(n) {
  if (!running || !awaiting || !current) return;
  awaiting = false;
  updatePadAvailability();

  const ok = (n === current.total);
  showFeedback(ok, current.total);

  if (ok) {
    await wait(900);
    hideFeedback();
    await wait(120);
    await nextRound();
  } else {
    await wait(650);
    hideFeedback();
    await wait(120);
    await replaySame();
  }
}

function wireToggleGroup(el) {
  el.querySelectorAll(".tbtn").forEach(btn => {
    btn.addEventListener("click", () => {
      btn.classList.toggle("active");
      lastKey = "";
      updatePadAvailability();
    });
  });
}

function wireControls() {
  wireToggleGroup(diceCountGroup);
  wireToggleGroup(typeGroup);
  wireToggleGroup(relGroup);

  [minTotal, maxTotal].forEach(inp => inp.addEventListener("input", () => {
    lastKey = "";
    updatePadAvailability();
  }));

  flashMs.addEventListener("input", () => {
    flashLabel.textContent = String(flashMs.value);
    lastKey = "";
  });

  startBtn.addEventListener("click", async () => {
    running = !running;
    startBtn.textContent = running ? "â¸" : "â–¶";
    hideFeedback();
    hideDice();
    awaiting = false;
    updatePadAvailability();
    if (running) {
      await wait(120);
      await nextRound();
    }
  });

  fsBtn.addEventListener("click", async () => {
    try {
      if (!document.fullscreenElement) {
        await document.documentElement.requestFullscreen();
      } else {
        await document.exitFullscreen();
      }
    } catch (e) {}
  });
}

diceImg.addEventListener("error", () => {
  if (!current) return;
  ALL_ITEMS = ALL_ITEMS.filter(it => it.src !== current.src);
  lastKey = "";
  if (running) nextRound();
});


async function validateAssets(items) {
  const ok = [];
  const limit = 4;
  let idx = 0;

  async function tryOne(it) {
    return await new Promise(resolve => {
      const im = new Image();
      let done = false;
      const finish = (v) => { if (done) return; done = true; resolve(v); };
      im.onload = () => finish(true);
      im.onerror = () => finish(false);
      im.src = it.src;
      // kleine failsafe, geen eindeloze hang
      setTimeout(() => finish(false), 3500);
    });
  }

  async function worker() {
    while (idx < items.length) {
      const i = idx++;
      const it = items[i];
      const ok1 = await tryOne(it);
      if (ok1) ok.push(it);
    }
  }

  await Promise.all(Array.from({length: limit}, () => worker()));
  return ok;
}


(async function init() {
  buildPad();
  wireControls();

  flashLabel.textContent = String(flashMs.value);
  hideDice();
  hideFeedback();

  syncTopbarHeight();
  try {
    new ResizeObserver(syncTopbarHeight).observe(topbar);
  } catch (e) {
    window.addEventListener("resize", syncTopbarHeight);
  }

  ALL_ITEMS = await validateAssets(RAW_ITEMS);

  lastKey = "";
  updatePadAvailability();
})();
</script>
</body>
</html>
